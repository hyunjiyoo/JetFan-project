<link rel="stylesheet" href="{{ url_for('static', filename='css/dist/trace.css') }}">

{% include 'header.html' %}
    
<div class="content-body">
    <h3>JetFan 추적도면 관리</h3>

    <div id='body-header'>
        <div>
            <select name="dept" id="dept" onchange='setOptionBox("dept", "branch")'>
                <option value="0">본부</option>
                {% for dept in depts %}
                <option value="{{ dept['div_code'] }}">
                    {{ dept['div_name'] }}
                </option>
                {% endfor %}
            </select>
            <select name="branch" id="branch" onchange='setOptionBox("branch", "tunnel")' data-div='branch'>
                <option value="0">지사</option>
            </select>
            <select name="tunnel" id="tunnel" onchange='setOptionBox("tunnel", "jetfan_way")' data-div='tunnel'>
                <option value="0">터널</option>
            </select>
        </div>

        <div>
            <select name="jetfan_way" id="jetfan_way" onchange='setOptionBox("tunnel", "jetfan_lane")' data-div='jetfan_way'>
                <option value="0">방향</option>
            </select>
            <select name="jetfan_lane" id="jetfan_lane" data-div='jetfan_lane' onchange='setOptionBox("tunnel", "jetfan_no")'>
                <option value="0">차선</option>
            </select>
            <select name="jetfan_no" id="jetfan_no" data-div='jetfan_no' onchange='setOptionBox("jetfan_no", "year")'>
                <option value="0">제트팬</option>
            </select>
        </div>
        <div>
            <select name="year" id="year" data-div='eval_year' onchange='setStatusChk()'>
                <option value="0">연도</option>
            </select>
        </div>
    </div>

    <div id="contents">
        <div id="history">
            <table>
                <tr>
                    <td colspan='4' class='table-header'>시설이력</td>
                </tr>
                <tr>
                    <td class='table-title'>터널명</td>
                    <td id='tunn_name'></td>
                    <td class='table-title'>방향</td>
                    <td id='way'></td>
                </tr>
                <tr>
                    <td class='table-title'>차선</td>
                    <td id='lane'></td>
                    <td class='table-title'>관리번호</td>
                    <td id='jetfan_name'></td>
                </tr>
                <tr>
                    <td colspan='1' class='table-title'>제조사</td>
                    <td colspan='3' id='jetfan_maker'></td>
                </tr>
                <tr>
                    <td colspan='1' class='table-title'>점검자</td>
                    <td colspan='3' id='eval_emp'></td>
                </tr>
                <tr>
                    <td colspan='1' class='table-title'>점검일자</td>
                    <td colspan='3' id='eval_ymd'></td>
                </tr>
            </table>

            <div id='planImg'>
                <img src="http://via.placeholder.com/100x100" alt="planning_image">
            </div>
        </div>

        <div id="operationChk">
            <table>
                <tr>
                    <td colspan='5' class='table-header'>운전점검</td>
                </tr>
                <tr>
                    <td rowspan='5' colspan='1' class='table-title'>진동</td>
                    <td colspan='4' class='table-title'>턴버클 & FAN 안정판 체결부위</td>
                </tr>
                <tr>
                    <td rowspan='2' class='table-title'>구분</td>
                    <td class='table-title'>V</td>
                    <td class='table-title'>H</td>
                    <td class='table-title'>A</td>
                </tr>
                <tr>
                    <td class='table-title'>수직</td>
                    <td class='table-title'>수평</td>
                    <td class='table-title'>축</td>
                </tr>
                <tr>
                    <td class='table-title'>①</td>
                    <td class='center' id='eval_vibrate_y_1'></td>
                    <td class='center' id='eval_vibrate_x_1'></td>
                    <td class='center' id='eval_vibrate_z_1'></td>
                </tr>
                <tr>
                    <td class='table-title'>②</td>
                    <td class='center' id='eval_vibrate_y_2'></td>
                    <td class='center' id='eval_vibrate_x_2'></td>
                    <td class='center' id='eval_vibrate_z_2'></td>
                </tr>
                <tr>
                    <td class='table-title'>운전 전류</td>
                    <td class='table-title'>구분</td>
                    <td class='table-title'>R</td>
                    <td class='table-title'>S</td>
                    <td class='table-title'>T</td>
                </tr>
                <tr>
                    <td class='table-title'>(A)</td>
                    <td class='table-title'>측정값</td>
                    <td class='center' id='eval_amp_r'></td>
                    <td class='center' id='eval_amp_s'></td>
                    <td class='center' id='eval_amp_t'></td>
                </tr>
                <tr>
                    <td colspan='2' class='table-title'>전압(V)</td>
                    <td colspan='3' class='center' id='eval_volt'></td>
                </tr>

            </table>
        </div>

        <div id="curStatusChk" data-div='curStatusChk'>
            <table>
                <tr><td class='table-header'>현상태점검현황</td></tr>
            </table>
        </div>

        <div id='etc'>
            <table>
                <tr><td class='table-header'>비고(기능상태 등)</td></tr>
            </table>
            <button id='inputBtn' type='button'>입력</button>
        </div>
    </div>
</div>



{% include 'footer.html' %}
<script>

// 콤보박스 세팅
const setOptionBox = (target, nextTarget) => {
    const opt = document.querySelectorAll(`#${nextTarget} option`);
    if(opt.length > 1) {
        for(let i = opt.length-1; i > 0; i--) {
            opt[i].remove();
        }
    }

    const _target = document.querySelector(`#${target}`);
    const _nextTarget = document.querySelector(`#${nextTarget}`);
    const data = { 'div_code': _target.value, 'div': _nextTarget.dataset.div };
    const xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState === 4 && this.status === 200) {
            let data = JSON.parse(this.responseText);
            console.log('data :>> ', data);
            switch(nextTarget) {
                case 'branch':
                    const bran_name = data.filter((elem, i) => i%2===0);
                    const bran_code = data.filter((elem, i) => i%2===1);
        
                    for(let j = 0; j < data.length/2; j++) {
                        let opt = document.createElement('option');
                        document.querySelector(`#${nextTarget}`).appendChild(opt);
                        opt.innerText = bran_name[j];
                        opt.value = bran_code[j];
                    }
                    break;
                
                case 'tunnel':
                    const tunn_name = data.filter((elem, i) => i%2===0);
                    const tunn_code = data.filter((elem, i) => i%2===1);

                    for(let j = 0; j < data.length/2; j++) {
                        let opt = document.createElement('option');
                        document.querySelector(`#${nextTarget}`).appendChild(opt);
                        opt.innerText = tunn_name[j];
                        opt.value = tunn_code[j];
                    }
                    break;
                
                case 'jetfan_way':
                    const jetfan_way = data.filter((x, i, a) => a.indexOf(x) == i);
                    const tunnel_name = document.querySelectorAll('#tunnel option')[document.querySelector('#tunnel').selectedIndex].text;
                    document.querySelector('#tunn_name').innerText = tunnel_name + '터널';
                    
                    for(let j = 0; j < jetfan_way.length; j++) {
                        let opt = document.createElement('option');
                        document.querySelector(`#${nextTarget}`).appendChild(opt);
                        opt.innerText = jetfan_way[j];
                    }
                    break;
                
                case 'jetfan_lane':
                    const jetfan_lane = data.filter((x, i, a) => a.indexOf(x) == i);
                    const way = document.querySelectorAll('#jetfan_way option')[document.querySelector('#jetfan_way').selectedIndex].text;
                    document.querySelector('#way').innerText = way + '방향';
                    
                    for(let j = 0; j < jetfan_lane.length; j++) {
                        let opt = document.createElement('option');
                        document.querySelector(`#${nextTarget}`).appendChild(opt);
                        opt.innerText = jetfan_lane[j];
                    }
                    break;
                
                case 'jetfan_no':
                    let jetfan_no = data.filter((elem, i) => i%4===0).filter((x, i, a) => a.indexOf(x) == i);
                    const jetfan_code = data.filter((elem, i) => i%4===1);
                    const jetfan_maker = data.filter((elem, i) => i%4===2).filter((x, i, a) => a.indexOf(x) == i)[0];
                    const jetfan_diagram = data.filter((elem, i) => i%4===3);

                    const jetfanLaneElem = document.querySelectorAll('#jetfan_lane option')[document.querySelector('#jetfan_lane').selectedIndex];
                    document.querySelector('#lane').innerText = jetfanLaneElem.text + '차선';
                    
                    if(jetfanLaneElem.text === '주행') {
                        jetfan_no = jetfan_no.filter((jetfan)=>jetfan.includes('JF-1'))
                    } else {
                        jetfan_no = jetfan_no.filter((jetfan)=>jetfan.includes('JF-2'))
                        
                        let j = 0;
                        for(let i = jetfan_no.length+1; i < jetfan_code.length; i++) {
                            jetfan_code[j] = jetfan_code[i];
                            jetfan_diagram[j] = jetfan_diagram[i];
                            j++;
                        }
                    }

                    for(let j = 0; j < jetfan_no.length; j++) {
                        let opt = document.createElement('option');
                        document.querySelector(`#${nextTarget}`).appendChild(opt);
                        opt.innerText = jetfan_no[j];
                        opt.value = jetfan_code[j];
                        opt.dataset.jetfan_maker = jetfan_maker;
                        opt.dataset.jetfan_diagram = jetfan_diagram[j];
                    }
                    
                    break;

                case 'year':
                    const eval_year = data[0].split(', ');
                    const eval_emp = data[1];
                    const eval_ymd = data[2].slice(0, 10);
                    const jetfanNoElem = document.querySelectorAll('#jetfan_no option')[document.querySelector('#jetfan_no').selectedIndex];

                    document.querySelector('#jetfan_name').innerText = jetfanNoElem.text;
                    document.querySelector('#eval_emp').innerText = eval_emp;
                    document.querySelector('#eval_ymd').innerText = eval_ymd;
                    document.querySelector('#jetfan_maker').innerText = jetfanNoElem.dataset.jetfan_maker;
                    document.querySelector('#planImg img').src = './jetfan/2020/' + jetfanNoElem.dataset.jetfan_diagram;
                    
                    // 운전 점검
                    document.querySelector('#eval_vibrate_y_1').innerText = data[3];
                    document.querySelector('#eval_vibrate_x_1').innerText = data[4];
                    document.querySelector('#eval_vibrate_z_1').innerText = data[5];
                    document.querySelector('#eval_vibrate_y_2').innerText = data[6];
                    document.querySelector('#eval_vibrate_x_2').innerText = data[7];
                    document.querySelector('#eval_vibrate_z_2').innerText = data[8];
                    document.querySelector('#eval_amp_r').innerText = data[9];
                    document.querySelector('#eval_amp_s').innerText = data[10];
                    document.querySelector('#eval_amp_t').innerText = data[11];
                    document.querySelector('#eval_volt').innerText = data[12];

                    for(let j = 0; j < eval_year.length; j++) {
                        let opt = document.createElement('option');
                        document.querySelector(`#${nextTarget}`).appendChild(opt);
                        opt.innerText = eval_year[j];
                    }

                    break;
                
            }
        }
    }

    xhttp.open("POST", "/trace", true);
    xhttp.setRequestHeader('Content-Type', 'application/json');
    xhttp.send(JSON.stringify(data));
}



const setStatusChk = () => {
    const curStatusChk = document.querySelector('#curStatusChk');
    const jetfan_no = document.querySelector('#jetfan_no');
    
    const data = { 'div_code': jetfan_no.value, 'div': curStatusChk.dataset.div };
    const xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if(this.readyState === 4 && this.status === 200) {
            let data = JSON.parse(this.responseText);

            // 현 상태 점검 현황
            const tc_seq = data[0].filter((elem, i) => i%2===0);
            const tc_content = data[0].filter((elem, i) => i%2===1);
            const chkTbl = document.querySelector('#curStatusChk table');
            for(let i = 0; i < tc_content.length; i++) {
                let tr = document.createElement('tr');
                let td = document.createElement('td');
                let input = document.createElement('input');
                chkTbl.appendChild(tr);
                tr.appendChild(td);
                td.appendChild(input);
                input.type = 'text';
                input.maxLength = 40;
                input.value = tc_content[i];
            }

            
            // 비고 데이터
            const setNoteArr = (arr, opt) => {
                const tn_year = arr.filter((elem, i) => i%3===0);
                const tn_seq = arr.filter((elem, i) => i%3===1);
                const tn_content = arr.filter((elem, i) => i%3===2);

                const etcTbl = document.querySelector('#etc table');
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                etcTbl.appendChild(tr);
                tr.appendChild(td);
                td.className = 'table-title';
                td.innerText = tn_year[0].replaceAll("'", "") + '년도';

                for(let i = 0; i < tn_content.length; i++) {
                    let tr = document.createElement('tr');
                    let td = document.createElement('td');
                    etcTbl.appendChild(tr);
                    tr.appendChild(td);
                    switch(opt) {
                        case 'noteCurYear':
                            let input = document.createElement('input');
                            td.appendChild(input);
                            input.type = 'text';
                            input.maxLength = 28;
                            input.value = tn_content[i];
                            break;
                        
                        case 'noteOneYearAgo':
                        case 'noteTowYearAgo':
                            td.innerText = tn_content[i];
                            break;
                    }
                }
            }

            setNoteArr(data[1], 'noteCurYear');
            setNoteArr(data[2], 'noteOneYearAgo');
            setNoteArr(data[3], 'noteTowYearAgo');
        }
    }

    xhttp.open('POST', '/trace', true);
    xhttp.setRequestHeader('Content-Type', 'application/json');
    xhttp.send(JSON.stringify(data));
}

</script>